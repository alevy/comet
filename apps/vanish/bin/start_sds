#!/bin/bash
# Starts the SDS service. 

USAGE="USAGE: $0 <service class name> [--expt <root logdir>] [<options for service>]\n\
\t--expt means experimental mode, with logging to a date-marked file"

# Example usages:
# - For experimentation: 
#     sh start_sds edu.washington.cs.vanish.service.SDSService \
#        --expt /homes/sys/roxana/UW/security_599g/security_sds/src/logs/performance_expts
# - For others:
#     sh start_sds edu.washington.cs.vanish.service.SDSService \
#        [--logdir /homes/sys/roxana/UW/security_599g/security_sds/src/logs/performance_expts/logs] 
#     

JAVA_OPTIONS="-Xms100m -Xmx512m"

DEFAULT_SDS_ROOT="`cat "conf/sds.conf" | grep "sds.rootdir" | awk -F"=" '{print $2}'`"

service_class="edu.washington.cs.vanish.service.SDSService"
if [ $# -ge 1 ]; then 
   service_class=$1; shift
fi

if [ $# -ge 1 ]; then
  if [ $1 == "--expt" ]; then
    shift
    if [ $# -lt 1 ]; then
      echo $USAGE
      exit 1
    fi
    logdir=$1; shift
    date=`date +"%y-%m-%d_%H-%M-%S"`
    logdir="$logdir/$date"

  else if [ $1 == "--logdir" ]; then
  	   shift
	   if [ $# -lt 1 ]; then
	       echo $USAGE
	       exit 1
	   fi
           logdir=$1; shift
       fi
  fi
fi

if [ -z $SDS_ROOT ]; then
  SDS_ROOT=$DEFAULT_SDS_ROOT
fi

export JAVA=`cat "$SDS_ROOT/conf/sds.conf" | grep "java\.exe" | awk -F"=" '{print $2}'`
if [ -z $logdir ]; then
  logdir=`cat "$SDS_ROOT/conf/sds.conf" | grep "sds\.logdir" | awk -F"=" '{print $2}'`
fi

if [ ! -e $logdir ]; then
   mkdir -p $logdir
fi

echo "EXPERIMENT LOGDIR: $logdir (use the same directory for the client logfile)"

sds_lib="$SDS_ROOT/lib"
sds_build="$SDS_ROOT/build"

sds_service="$service_class"

# First, kill the old instance, if any.
for p in `ps -ef | grep java | grep sds | awk -F" " '{print $2}'`; do
  if [ $sds_service == "sds.expt.security.Controller" ]; then
    # Kill all sds processes, including the older controller.
    kill -9 $p
  else
    # Kill all sds processes, but not the Controller.
    if [ -z `ps -ef | grep $p | grep "\.Controller" | awk -F" " '{print $2}'` ]; then
      kill -9 $p
    fi
  fi
done

# Remove the DHT data.
rm -rf /tmp/dht/*

# Calculate classpath.
classpath="$sds_build"
for jar in $sds_lib/*.jar; do
    classpath=$classpath:$jar
done
export CLASSPATH=$classpath
echo $classpath

cd $SDS_ROOT

this_machine=`hostname`

# Runs the sds server in the background, logging output to the log file
command_line="$JAVA $JAVA_OPTIONS $sds_service -l $logdir -r $SDS_ROOT $@"
echo $command_line
if [ $logdir == "/dev/null" ]; then
  $command_line < /dev/null > /dev/null 2> /tmp/vanish.err &
else
  $command_line < /dev/null >& $logdir/$sds_service.$this_machine.log &
fi

